@{
	Layout = null;
}
@using EAD_project.Controllers
@model ViewModelBill
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MessHub - My Bills</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/userbill.css">
</head>
<body>

    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3><i class="bi bi-egg-fried me-2"></i>MessHub</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="@Url.Action("user_dashboard","Userdashboard")" class="nav-link"><i class="bi bi-grid-1x2-fill"></i> My Dashboard</a>
                <a href="@Url.Action("user_attendance","Userattendance")" class="nav-link"><i class="bi bi-calendar-check-fill"></i> My Attendance</a>
                <a href="@Url.Action("user_menu","Usermenu")" class="nav-link"><i class="bi bi-journal-text"></i> Menu</a>
                <a href="@Url.Action("user_bill","Bill_user")" class="nav-link active"><i class="bi bi-receipt"></i> My Bills</a>
                <a href="@Url.Action("user_dispute", "Userdispute")" class="nav-link"><i class="bi bi-exclamation-triangle-fill"></i> My Disputes</a>
                <a href="@Url.Action("user_profile", "Userprofile")" class="nav-link"><i class="bi bi-person-circle"></i> Profile</a>
            </nav>
            <div class="sidebar-footer">
                <a href="@Url.Action("logout", "Logout")" class="nav-link"><i class="bi bi-box-arrow-left"></i> Logout</a>
            </div>
        </aside>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navbar -->
            <header class="top-navbar">
                <button class="btn sidebar-toggle d-lg-none" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>
                <h4 class="page-title">My Bills</h4>
                <div class="navbar-right">
                    <span class="user-greeting">Welcome, <strong id="userName">Ahmed Ali</strong></span>
                    <div class="user-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                </div>
            </header>

            <!-- Bills Content -->
            <div class="dashboard-content">
                <!-- Current Bill Banner -->
                <div class="current-bill-banner">
                    <div class="banner-content">
                        <div class="banner-icon">
                            <i class="bi bi-receipt-cutoff"></i>
                        </div>
                        <div class="banner-info">
                            <h5>Current Month Bill</h5>
                            <h2 id="currentBillAmount">Rs. 0</h2>
                            <p><i class="bi bi-calendar-event me-2"></i><span id="currentMonth">December 2025</span></p>
                        </div>
                    </div>
                    <div class="banner-stats">
                        <div class="stat-item">
                            <i class="bi bi-calendar-check"></i>
                            <div>
                                <strong id="daysPresent">0</strong>
                                <span>Days Present</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <i class="bi bi-egg-fried"></i>
                            <div>
                                <strong id="mealsCount">0</strong>
                                <span>Total Meals</span>
                            </div>
                        </div>
                    </div>
                    <div class="banner-action">
                        <button class="btn btn-view-detail" onclick="viewBillDetail('current')">
                            <i class="bi bi-eye me-2"></i>View Details
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-left">
                        <h5><i class="bi bi-clock-history me-2"></i>Bill History</h5>
                    </div>
                    <div class="filter-right">
                        <select class="form-select filter-select" id="statusFilter" onchange="filterBills()">
                            <option value="all">All Status</option>
                            <option value="paid">Paid</option>
                            <option value="unpaid">Unpaid</option>
                        </select>
                        <select class="form-select filter-select" id="yearFilter" onchange="filterBills()">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                </div>

                <!-- Bills Grid -->
                <div class="bills-grid" id="billsGrid">
                    <!-- Bills will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Loading bills...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bill Detail Modal -->
    <div class="modal fade" id="billDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Bill Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="billDetailContent">
                    <!-- Bill details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="downloadBillBtn" onclick="downloadBill()">
                        <i class="bi bi-download me-2"></i>Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Make Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="payment-info">
                        <h6>Payment Details</h6>
                        <div class="payment-row">
                            <span>Bill Month:</span>
                            <strong id="paymentMonth">-</strong>
                        </div>
                        <div class="payment-row">
                            <span>Amount to Pay:</span>
                            <strong class="text-success" id="paymentAmount">Rs. 0</strong>
                        </div>
                    </div>
                    <hr>
                    <div class="payment-methods">
                        <h6>Select Payment Method</h6>

                        <!-- Bank Transfer -->
                        <div class="form-check payment-method-option">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="bank" checked onchange="showPaymentForm('bank')">
                            <label class="form-check-label" for="bankTransfer">
                                <i class="bi bi-bank me-2"></i>Bank Transfer
                            </label>
                        </div>
                        <div id="bankTransferForm" class="payment-form">
                            <div class="mb-3">
                                <label class="form-label">Account Number</label>
                                <input type="text" class="form-control" id="accountNumber" placeholder="Enter account number" maxlength="20">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Account Holder Name</label>
                                <input type="text" class="form-control" id="accountName" placeholder="Enter account holder name">
                            </div>
                        </div>

                        <!-- Credit/Debit Card -->
                        <div class="form-check payment-method-option">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="card" onchange="showPaymentForm('card')">
                            <label class="form-check-label" for="creditCard">
                                <i class="bi bi-credit-card me-2"></i>Credit / Debit Card
                            </label>
                        </div>
                        <div id="cardPaymentForm" class="payment-form" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Card Holder Name</label>
                                <input type="text" class="form-control" id="cardName" placeholder="Name on card">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">Expiry Date</label>
                                    <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">CVV</label>
                                    <input type="password" class="form-control" id="cvv" placeholder="123" maxlength="3">
                                </div>
                            </div>
                        </div>

                        <!-- Easypaisa/JazzCash -->
                        <div class="form-check payment-method-option">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="easypaisa" value="mobile" onchange="showPaymentForm('mobile')">
                            <label class="form-check-label" for="easypaisa">
                                <i class="bi bi-phone me-2"></i>Easypaisa / JazzCash
                            </label>
                        </div>
                        <div id="mobilePaymentForm" class="payment-form" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Mobile Number</label>
                                <input type="text" class="form-control" id="phoneNumber" placeholder="03001234567" maxlength="11">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">PIN Code</label>
                                <input type="password" class="form-control" id="mobilePin" placeholder="Enter 4-digit PIN" maxlength="4">
                            </div>
                        </div>

                        <!-- Cash Payment -->
                        <div class="form-check payment-method-option">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" onchange="showPaymentForm('cash')">
                            <label class="form-check-label" for="cash">
                                <i class="bi bi-cash me-2"></i>Cash Payment
                            </label>
                        </div>
                        <div id="cashPaymentForm" class="payment-form" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Please visit the mess office to make cash payment and collect your receipt.
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>After payment, please share the receipt with admin for verification.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="processPayment()">
                        <i class="bi bi-check-circle me-2"></i>Proceed to Pay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Custom JS -->
    <script>
    // Store data in a global object to ensure bill.js can access it
    window.messData = {
        users: @Html.Raw(Json.Serialize(Model.User.Select(u => new
            {
                userId = u.UserId,
                name = u.Name,
                username = u.Username,
                department = u.Department,
                cnic = u.Cnic,
                isActive = u.IsActive
            }))),

        bills: @Html.Raw(Json.Serialize(Model.Bills.Select(b => new
            {
                billId = b.BillId,
                userId = b.UserId,
                month = b.Month,
                year = b.Year,
                grandTotal = b.GrandTotal,
                isPaid = b.IsPaid,
                // FIX: Use '=' instead of ':' for C# property assignment
                totalTeaWaterAmount = b.TotalTeaWaterAmount,
                totalFoodAmount = b.TotalFoodAmount
            }))),

        attendances: @Html.Raw(Json.Serialize(Model.Attendances.Select(a => new
            {
                userId = a.UserId,
                attendanceDate = a.AttendanceDate,
                mealType = a.MealType,
                teaWater = a.TeaWater,
                food = a.Food,
                foodPrice = a.FoodPrice
            })))
    };
</script>
    <script src="~/js/userbill.js"></script>
</body>
</html>
